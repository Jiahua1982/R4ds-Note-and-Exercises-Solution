---
title: "R4ds Chapter 5 Data Transformation Yuqing Xue Personal Note"
author: "Yuqing Xue"
date: "October 22, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br>

Notes and code follow Hadley Wickham's 'R for Data Science' material, Chapter 5. <http://r4ds.had.co.nz/transform.html#introduction-2>

### 5.1 Introduction


#### `nycflights13`
```{r message=FALSE, warning=FALSE}
##########################################
####### Dataset: nycflights13::flights
########################################## 
library(nycflights13)
library(tidyverse)
nycflights13::flights
```

<br>

### 5.2 Filter

#### Explore, try `%in%`
```{r explore}

jan1 <- filter(flights, month == 1, day == 1)

nov_and_dec = filter(flights, month == 11 | month == 12)
## A useful short-hand for this problem is x %in% y. This will select every row where x is one of the values in y.
nov_dec <- filter(flights, month %in% c(11, 12))
```

```{r NYC to San Fransisco Bay Area}

NYCtoSF <-  
  flights %>% 
    filter(dest %in% c("SFO", "OAK", "SJC")) %>%
      select(year, month, day, carrier, origin, dest, air_time)
NYCtoSF

NYCtoSF2 <-  
  flights %>% 
    filter(dest == "SFO" | dest == "OAK" |  dest == "SJC") %>%
      select(year, month, day, carrier, origin, dest, air_time)
NYCtoSF2

# H.W. As well as & and |, R also has && and ||. Don’t use them here! You’ll learn when you should use them in conditional execution.

``` 

<br>

###  5.2.4 Exercises
### 1. Find all flights that
##### 1.1 Had an arrival delay of two or more hours
##### 1.2. Flew to Houston (IAH or HOU)
##### 1.3. Were operated by United, American, or Delta
##### 1.4. Departed in summer (July, August, and September)
##### 1.5. Arrived more than two hours late, but didn’t leave late
##### 1.6. Were delayed by at least an hour, but made up over 30 minutes in flight
##### 1.7. Departed between midnight and 6am (inclusive)

```{r exercise 1.1}
 
Ex1.1 <- 
  flights %>%
    filter(arr_delay >= 120) %>%
      arrange(desc(arr_delay)) %>%
        select(month, day, carrier, origin, dest, dep_delay, arr_delay)
Ex1.1
```

```{r exercise 1.2 - 1.4}
Ex1.2 = filter(flights, dest %in% c("IAH","HOU"))
Ex1.3 = filter(flights, carrier %in% c("UA","AA","DL"))
Ex1.4 = filter(flights, month %in% c(7,8,9))
```

```{r exercise 1.5 - 1.7}
Ex1.5 = filter(flights, arr_delay >= 120 & dep_delay <= 0 )
Ex1.6 = filter(flights, dep_delay >= 60 & dep_delay - arr_delay >= 30)
Ex1.7 = filter(flights, dep_time <= 600)
```

<br>

#### 2. Another useful dplyr filtering helper is `between()`. What does it do? Can you use it to simplify the code needed to answer the previous challenges?

```{r exercise 2}
?between
Ex1.4b = filter(flights, between(month, 7, 9))
```

<br>

#### 3. How many flights have a missing dep_time? What other variables are missing? What might these rows represent?

```{r exercise 3}
sum(is.na(flights$dep_time)) # 8255

flights_missing_dep_time <- flights %>% filter(is.na(dep_time))
flights_missing_dep_time 

flights_cancelled <- flights %>% 
  filter(is.na(dep_time) & is.na(dep_delay) & is.na(arr_time) & is.na(arr_delay) & is.na(arr_time))
# same 8255 flights
```

Along with dep_time, dep_delay, arr_time, arr_delay and air_time are also missing, for all 8255 flights. It probably means that those flights were cancelled.

<br>

#### 4. Why is `NA ^ 0` not missing? Why is `NA | TRUE` not missing? Why is `FALSE & NA` not missing? Can you figure out the general rule? (`NA * 0` is a tricky counterexample!)

`NA ^ 0` returns 1. Any number to the power of 0 is 1, whether the number is missing or not does not matter.

`NA | TRUE` returns TRUE, since the `|` operator returns TRUE if either of the terms are TRUE. In this case, the right half is TRUE, so the whole expression will always return TRUE. 

`FALSE & NA` returns FALSE, because operator `&` returns TRUE when both terms are true. The left half is FALSE, so the whole expression returns FALSE despite the NA on the right half.

```{r}
NA * 0
```

`NA * 0` returns 0, whicn may rendered the general rule we discovered from the previous not definite: if NA represent a value that is `Inf`, and we know `Inf` * 0 should not be a number, i.e., `NaN`.

<br>

### 5.3 Arrange

`arrange()` works similarly to `filter()` except that instead of selecting rows, it changes their order. It takes a data frame and a set of column names (or more complicated expressions) to order by. If you provide more than one column name, each additional column will be used to break ties in the values of preceding columns:

```{r}
arrange(flights, year, month, day)
arrange(flights, desc(arr_delay))
```

```{r}
df <- tibble(x = c(5, 2, NA))
arrange(df, x)
```
In this way, `x` then becomes the column name of the tibble `df`.

<br>

#### 5.3.1 Exercise
##### 1. How could you use `arrange()` to sort all missing values to the start? (Hint: use `is.na()`).

```{r}
arrange(df, !is.na(x))
```
It seems that R recognized `FALSE` as 0 and `TRUE` as 1, so `FALSE` is less than `TRUE`, hence can be ordered.


##### 2. Sort `flights` to find the most delayed flights. Find the flights that left earliest.

```{r}
colnames(flights)
flights %>% 
  arrange(desc(arr_delay))

flights %>%
  arrange(dep_time)
```

which may lead to an idea of creating a function:

idea: topRanking (smallest/largest, variable) and put it on Shiny

##### 3. Sort `flights` to find the fastest flights.
Idea: create a variable `timeOnAir` to measure the flight time.

Tricky: The way how `dep_time` and `arr_time` is coded needs a slightly modification.
```{r}
flights %>% 
  mutate(timeOnAir = ifelse(arr_time - dep_time < 0, arr_time + 2400 - dep_time, arr_time - dep_time)) %>%
    select(origin, dest, dep_time, sched_dep_time, arr_time, sched_arr_time, timeOnAir) %>%
      arrange(timeOnAir)

# and the slowest flights 
flights %>%
  mutate(timeOnAir = ifelse(arr_time - dep_time < 0, arr_time + 2400 - dep_time, arr_time - dep_time)) %>%
    select(origin, dest, dep_time, sched_dep_time, arr_time, sched_arr_time, timeOnAir) %>%
      arrange(desc(timeOnAir))

flights_Testimate <- flights %>%
  mutate(timeOnAir = ifelse(arr_time - dep_time < 0, arr_time + 2400 - dep_time, arr_time - dep_time)) 
```
The most unexpected flights, like the one from EWR to ORD that took 19 hours 25 minutes, can be spotted and further investigated.


##### 4. Which flights travelled the longest? Which travelled the shortest?
Idea: sort variable `distance`
```{r}
# The longest flights
flights_Testimate %>%
  select(carrier:distance, timeOnAir) %>%
    arrange(desc(distance))

# The longest flight where destination is not HNL
flights_Testimate %>%
  select(carrier:distance, timeOnAir) %>%
    filter(dest != 'HNL') %>%
      arrange(desc(distance))

# Besides HNL and ANC
flights_Testimate %>%
  select(carrier:distance, timeOnAir) %>%
    filter(dest != 'HNL' & dest != "ANC") %>%
      arrange(desc(distance))
```
The second longest flight is from EWR to ANC. The third one is to SFO.

```{r}
# The shortest flights
flights_Testimate %>%
  select(carrier:distance, timeOnAir) %>%
    arrange(distance)

```

```{r}
flights_Testimate %>%
  filter(distance == 17)
```




